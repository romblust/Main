local Adonis = {}

Adonis.DebugMode = false
Adonis.Emulator = false
Adonis.Coroutine = false
Adonis.MessageOut = false

local Table = {}
local SetUpValue = setupvalue or debug.setupvalue or setvalue
local ClientTable = nil
local FoundSend = false

local Stats = {
    AntiCheatFunctions = 0,
    ClientFunctions = 0,
    RemoteFunctions = 0,
    ProcessFunctions = 0,
    DetectedTables = 0,
    DisconnectHooks = 0,
    KillHooks = 0,
    DetectedHooks = 0,
    DetectorHooks = 0,
    MessageOutConnections = 0
}

local Detectors = {
    "indexInstance",
    "newindexInstance", 
    "namecallInstance",
    "indexEnum",
    "namecallEnum",
    "eqEnum",
    "MTABLE_CHECK",
    "QUEUE_CHECK", 
    "HIDDEN_PROP",
    "UPVALUE_CHECK",
    "CONSTANT_CHECK",
    "NEWCCLOSURE_CHECK",
    "FUNCTION_CHECK",
    "REMOTE_SPY",
    "HOOKFUNCTION_CHECK"
}

function Adonis:Init()
    if not game:IsLoaded() then 
        game.Loaded:Wait() 
    end

    local ScriptContext = game:GetService("ScriptContext")
    ScriptContext:SetTimeout(2.5)

    local Players = game:GetService("Players")
    local LogService = game:GetService("LogService")
    local RunService = game:GetService("RunService")

    local LocalPlayer = Players.LocalPlayer

    local OldNamecall; OldNamecall = hookmetamethod(game, "__namecall", newcclosure(function(Self, ...)
        if checkcaller() then
            return OldNamecall(Self, ...)
        end
        
        local Method = getnamecallmethod()
        local Args = {...}
        
        if Method == "Kick" and typeof(Self) == "Instance" and Self == LocalPlayer then
            if Adonis.DebugMode then
                warn("Blocked Kick Attempt!\n")
            end
            return
        end
        
        if (Method == "FireServer" or Method == "InvokeServer") and typeof(Self) == "Instance" then
            local RemoteName = Self.Name
            if RemoteName:find("AC_") or RemoteName:find("Detected") or RemoteName:find("Client_") then
                if Adonis.DebugMode then
                    warn(string.format("Blocked Remote: %s\n", RemoteName))
                end
                return
            end
        end
        
        return OldNamecall(Self, ...)
    end))

    local DInfo; DInfo = hookfunction(debug.info, newcclosure(function(Caller, Options)
        if checkcaller() then 
            return DInfo(Caller, Options) 
        end
        
        Caller = type(Caller) == "number" and Caller + 1 or Caller
        
        local Success, CallingScript = pcall(getcallingscript)
        if Success and CallingScript and CallingScript.Name == "ClientMover" then
            if Adonis.DebugMode then 
                warn(string.format(
                    "Debug.Info Function Has Been Called!\nPassed Arguments: %s %s\n",
                    tostring(Caller),
                    tostring(Options)
                ))
            end

            if typeof(Caller) == "function" then
                local Name = DInfo(Caller, "n")
                if Name == "" and Options == "slanf" then
                    return coroutine.yield()
                end
            end

            return
        end

        return DInfo(Caller, Options)
    end))

    local SelfKick; SelfKick = hookfunction(LocalPlayer.Kick, newcclosure(function(Player, Reason)
        if checkcaller() then
            return SelfKick(Player, Reason)
        end

        local Success, CallingScript = pcall(getcallingscript)
        if Success and CallingScript and CallingScript.Name == "ClientMover" and Player == LocalPlayer then
            if Adonis.DebugMode then
                warn(string.format(
                    "LocalPlayer Kick Function Has Been Called!\nPassed Arguments: %s\n",
                    tostring(Reason)
                ))
            end
            return
        end

        return SelfKick(Player, Reason)
    end))

    local function GetInfo(func)
        if not func or typeof(func) ~= "function" then
            return {}
        end
        local Success, Result = pcall(debug.info, func, "nslaf")
        return Success and Result or {}
    end

	if Adonis.DebugMode and typeof(Collected) == "function" then
        local Success, Name, Source = pcall(function()
            return debug.info(Collected, "ns")
        end)
		
        if Success and Source and Source:find("Client") then
            warn("Found function:", Name, "in", Source)
        end
    end

    for _, Collected in getgc(true) do
        if typeof(Collected) == "function" then
            local Success, Name, Source = pcall(function()
                return debug.info(Collected, "ns")
            end)
            
            if not Success or not Source then
                continue
            end

            if Source:find(".Client.Core.Anti") then
                if Name == "compareTables" then
                    pcall(hookfunction, Collected, function(Table1, Table2)
                        if Adonis.DebugMode then
                            warn(string.format(
                                "Compare Tables Function Has Been Called!\nPassed Arguments: %s %s\n",
                                tostring(Table1),
                                tostring(Table2)
                            ))
                        end
                        return true
                    end)
                    Stats.AntiCheatFunctions = Stats.AntiCheatFunctions + 1

                elseif Name == "isMethamethodValid" then
                    pcall(hookfunction, Collected, function(Metamethod)
                        if Adonis.DebugMode then
                            warn(string.format(
                                "Is Metamethod Valid Function Has Been Called!\nPassed Arguments: %s\n",
                                tostring(Metamethod)
                            ))
                        end
                        return true
                    end)
                    Stats.AntiCheatFunctions = Stats.AntiCheatFunctions + 1

                elseif Name == "checkStack" then
                    pcall(hookfunction, Collected, function(Method)
                        if Adonis.DebugMode then
                            warn(string.format(
                                "Check Stack Function Has Been Called!\nPassed Arguments: %s\n",
                                tostring(Method)
                            ))
                        end
                        return false
                    end)
                    Stats.AntiCheatFunctions = Stats.AntiCheatFunctions + 1
                    
                elseif Name == "getInfo" then
                    pcall(hookfunction, Collected, function(...)
                        if Adonis.DebugMode then
                            warn("GetInfo Anti-Cheat Check Blocked!\n")
                        end
                        return {}
                    end)
                    Stats.AntiCheatFunctions = Stats.AntiCheatFunctions + 1
                    
                elseif Name == "checkUpvalues" then
                    pcall(hookfunction, Collected, function(...)
                        if Adonis.DebugMode then
                            warn("Check Upvalues Function Blocked!\n")
                        end
                        return true
                    end)
                    Stats.AntiCheatFunctions = Stats.AntiCheatFunctions + 1
                    
                elseif Name == "checkConstants" then
                    pcall(hookfunction, Collected, function(...)
                        if Adonis.DebugMode then
                            warn("Check Constants Function Blocked!\n")
                        end
                        return true
                    end)
                    Stats.AntiCheatFunctions = Stats.AntiCheatFunctions + 1
                    
                elseif Name == "scanRemotes" then
                    pcall(hookfunction, Collected, function(...)
                        if Adonis.DebugMode then
                            warn("Scan Remotes Function Blocked!\n")
                        end
                        return
                    end)
                    Stats.AntiCheatFunctions = Stats.AntiCheatFunctions + 1
                    
                elseif Name == "verifyPlayer" then
                    pcall(hookfunction, Collected, function(...)
                        if Adonis.DebugMode then
                            warn("Verify Player Function Blocked!\n")
                        end
                        return true
                    end)
                    Stats.AntiCheatFunctions = Stats.AntiCheatFunctions + 1
                    
                elseif Name == "checkProperty" then
                    pcall(hookfunction, Collected, function(...)
                        if Adonis.DebugMode then
                            warn("Check Property Function Blocked!\n")
                        end
                        return true
                    end)
                    Stats.AntiCheatFunctions = Stats.AntiCheatFunctions + 1
                end

            elseif Source:find(".Client.Client") then
                local Success2, Upvalues = pcall(debug.getupvalues, Collected)
                if not Success2 or not Upvalues then
                    continue
                end

                if #Upvalues == 3 then
                    local Functions = {}

                    for _, Value in Upvalues do
                        if typeof(Value) ~= "function" then
                            continue
                        end

                        local Info = GetInfo(Value)

                        if Info and (Info.name == "" or Info.name == "tostring" or Info.name == "logError") then
                            table.insert(Functions, Value)
                        end
                    end

                    if #Functions == 3 then
                        pcall(hookfunction, Collected, function(...) end)
                        Stats.ClientFunctions = Stats.ClientFunctions + 1
                    end
                end
                
            elseif Source:find(".Client.Core.Remote") then
                if Name == "FireServer" or Name == "InvokeServer" then
                    local OldFunc = Collected
                    pcall(hookfunction, Collected, function(Remote, ...)
                        local Args = {...}
                        if typeof(Remote) == "Instance" and (Remote.Name:find("AC_") or Remote.Name:find("Detected")) then
                            if Adonis.DebugMode then
                                warn(string.format("Blocked Remote Call: %s\n", Remote.Name))
                            end
                            return
                        end
                        return OldFunc(Remote, ...)
                    end)
                    Stats.RemoteFunctions = Stats.RemoteFunctions + 1
                end
                
            elseif Source:find(".Client.Core.Process") then
                if Name == "getPlayer" or Name == "checkPlayer" then
                    pcall(hookfunction, Collected, function(...)
                        return LocalPlayer
                    end)
                    Stats.ProcessFunctions = Stats.ProcessFunctions + 1
                end
            end
        end

        if typeof(Collected) == "table" then
            local Detected   = rawget(Collected, "Detected")
            local Disconnect = rawget(Collected, "Disconnect")
            local Kill       = rawget(Collected, "Kill")
            local Send       = rawget(Collected, "Send")
            local DepsName   = rawget(Collected, "DepsName")
            local Variables  = rawget(Collected, "Variables")
            local Process    = rawget(Collected, "Process")

            if DepsName then
                ClientTable = Collected
                Stats.DetectedTables = Stats.DetectedTables + 1
            end
            
            if Variables and typeof(Variables) == "table" then
                local TrackingMouse = rawget(Variables, "TrackingMouse")
                if TrackingMouse ~= nil then
                    pcall(rawset, Variables, "TrackingMouse", false)
                end
            end
            
            if Process and typeof(Process) == "table" then
                for Key, Value in pairs(Process) do
                    if typeof(Value) == "function" then
                        local Info = GetInfo(Value)
                        if Info and Info.short_src and Info.short_src:find(".Client.Core.Process") then
                            pcall(hookfunction, Value, function(...)
                                return true
                            end)
                        end
                    end
                end
            end

            if Adonis.Emulator and typeof(Send) == "function" and not FoundSend then
                local Info = GetInfo(Send)
                local Path = Info and Info.short_src

                if Path and Path:find(".Client.Core.Remote") then
                    FoundSend = true

                    task.spawn(function()
                        if Adonis.DebugMode then
                            warn("Starting To Emulate Remote Sending...\n")
                        end

                        while true do
                            if typeof(ClientTable) ~= "table" then
                                task.wait()
                                continue
                            end

                            pcall(Send, "ClientCheck", {
                                Sent     = ClientTable.Remote and ClientTable.Remote.Sent or 0,
                                Received = ClientTable.Remote and ClientTable.Remote.Received or 0,
                            }, ClientTable.DepsName)

                            if Adonis.DebugMode then
                                warn("Emulator: Fired Remote Client Check To Server!\n")
                            end

                            task.wait(15)
                        end
                    end)
                end
            end

            if Disconnect and typeof(Disconnect) == "function" then
                local Info = GetInfo(Disconnect)
                local Path = Info and Info.short_src

                if Path and Path:find(".Client.Client") then
                    pcall(hookfunction, Disconnect, function(Info)
                        if Adonis.DebugMode then
                            warn(string.format(
                                "Disconnect Function Has Been Called!\nPassed Arguments: %s\n",
                                tostring(Info)
                            ))
                        end
                        return
                    end)
                    Stats.DisconnectHooks = Stats.DisconnectHooks + 1
                end
            end

            if Kill and typeof(Kill) == "function" then
                local Info = GetInfo(Kill)
                local Path = Info and Info.short_src

                if (Path and Path:find(".Client.Client")) or (Path and Path:find("ClientMover")) then
                    pcall(hookfunction, Kill, function(Info)
                        if Adonis.DebugMode then
                            warn(string.format(
                                "Kill Function Has Been Called!\nPassed Arguments: %s\n",
                                tostring(Info)
                            ))
                        end
                        return
                    end)
                    Stats.KillHooks = Stats.KillHooks + 1
                end
            end

            if Detected and typeof(Detected) == "function" then
                local Info = GetInfo(Detected)
                local Path = Info and Info.short_src

                if Path and Path:find(".Client.Core.Anti") then
                    pcall(hookfunction, Detected, function(Action, Info, NoCrash)
                        if Adonis.DebugMode then
                            warn(string.format(
                                "Detected Function Has Been Called!\nPassed Arguments: %s %s %s\n",
                                tostring(Action),
                                tostring(Info),
                                tostring(NoCrash)
                            ))
                        end
                        return true
                    end)
                    Stats.DetectedHooks = Stats.DetectedHooks + 1
                end
            end

            for _, Method in Detectors do
                local Detector = rawget(Collected, Method)
                if not Detector or typeof(Detector) ~= "table" then
                    continue
                end

                local DetectedF = rawget(Detector, 2)
                if typeof(DetectedF) ~= "function" then
                    continue
                end

                pcall(hookfunction, DetectedF, function()
                    if Adonis.DebugMode then
                        warn(string.format("%s Function Has Been Called!\n", Method))
                    end

                    return false
                end)
                Stats.DetectorHooks = Stats.DetectorHooks + 1
            end
        end
    end

    if Adonis.Coroutine then
        local OriginalNameCall; OriginalNameCall = hookmetamethod(game, "__namecall", newcclosure(function(Object, ...)
            local Arguments = {...}
            local Method = getnamecallmethod()
            if Method == "FireServer" and typeof(Object) == "Instance" and Object.Name == "MainRemoteEvent" and Arguments[1] == "Detection" then
                return coroutine.yield()
            end
            return OriginalNameCall(Object, ...)
        end))
    end

    RunService.Heartbeat:Connect(function()
        if not Adonis.MessageOut then
            return
        end

        for _, Connected in pairs(getconnections(LogService.MessageOut)) do
            if not table.find(Table, Connected) then
                Table[# Table + 1] = Connected
                local Success, User = pcall(getupvalues, Connected.Function)
                if not Success or not User then
                    continue
                end

                if # User >= 9 and type(User[9]) == "table" and type(User[9][1]) == "function" then
                    pcall(SetUpValue, User[9][1], 14, function()
                        return function(Conntected)
                            if type(Conntected) == "table" then
                                for Index = 1, 4 do
                                    if type(Conntected[Index]) == "userdata" and Conntected[Index].Disconnect then
                                        pcall(Conntected[Index].Disconnect, Conntected[Index])
                                    end
                                end
                            end
                        end
                    end)

                    pcall(SetUpValue, User[9][1], 1, function()
                        task.wait(200)
                    end)

                    local Old_ = User[9][1]
                    pcall(hookfunction, User[9][1], function()
                        return {}
                    end)
                    
                    Stats.MessageOutConnections = Stats.MessageOutConnections + 1
                end
            end
        end
    end)
    
    if Adonis.DebugMode then
        task.spawn(function()
            task.wait(3)
            warn("=== Adonis Bypass Statistics ===")
            warn(string.format("Anti-Cheat Functions Hooked: %d", Stats.AntiCheatFunctions))
            warn(string.format("Client Functions Hooked: %d", Stats.ClientFunctions))
            warn(string.format("Remote Functions Hooked: %d", Stats.RemoteFunctions))
            warn(string.format("Process Functions Hooked: %d", Stats.ProcessFunctions))
            warn(string.format("Client Tables Found: %d", Stats.DetectedTables))
            warn(string.format("Disconnect Hooks: %d", Stats.DisconnectHooks))
            warn(string.format("Kill Hooks: %d", Stats.KillHooks))
            warn(string.format("Detected Hooks: %d", Stats.DetectedHooks))
            warn(string.format("Detector Table Hooks: %d", Stats.DetectorHooks))
            warn(string.format("MessageOut Connections: %d", Stats.MessageOutConnections))
            warn("================================")
        end)
    end
end

return Adonis
